<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Front End Interview | MVVM 架构模式</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/front-end-interview/assets/css/28.styles.5282d56d.css" as="style"><link rel="preload" href="/front-end-interview/assets/js/app.5649801c.js" as="script"><link rel="preload" href="/front-end-interview/assets/js/25.bc1c1bd1.js" as="script"><link rel="prefetch" href="/front-end-interview/assets/js/12.b0b8bdc2.js"><link rel="prefetch" href="/front-end-interview/assets/js/0.63cbeaf2.js"><link rel="prefetch" href="/front-end-interview/assets/js/1.2d9d638f.js"><link rel="prefetch" href="/front-end-interview/assets/js/2.4ca1fdf9.js"><link rel="prefetch" href="/front-end-interview/assets/js/3.2e3fe001.js"><link rel="prefetch" href="/front-end-interview/assets/js/4.31fbc22a.js"><link rel="prefetch" href="/front-end-interview/assets/js/5.5ef9f123.js"><link rel="prefetch" href="/front-end-interview/assets/js/6.dfe2fc39.js"><link rel="prefetch" href="/front-end-interview/assets/js/7.3bea5043.js"><link rel="prefetch" href="/front-end-interview/assets/js/8.85ebb90b.js"><link rel="prefetch" href="/front-end-interview/assets/js/9.4189ba80.js"><link rel="prefetch" href="/front-end-interview/assets/js/10.56769ad8.js"><link rel="prefetch" href="/front-end-interview/assets/js/11.ee626e29.js"><link rel="prefetch" href="/front-end-interview/assets/js/13.a613c252.js"><link rel="prefetch" href="/front-end-interview/assets/js/14.06b06448.js"><link rel="prefetch" href="/front-end-interview/assets/js/15.7abf1950.js"><link rel="prefetch" href="/front-end-interview/assets/js/16.3b6bf73b.js"><link rel="prefetch" href="/front-end-interview/assets/js/17.66f95366.js"><link rel="prefetch" href="/front-end-interview/assets/js/18.3924f170.js"><link rel="prefetch" href="/front-end-interview/assets/js/19.bf168d25.js"><link rel="prefetch" href="/front-end-interview/assets/js/20.0d3a49f3.js"><link rel="prefetch" href="/front-end-interview/assets/js/21.f5a65c71.js"><link rel="prefetch" href="/front-end-interview/assets/js/22.cfd6dc92.js"><link rel="prefetch" href="/front-end-interview/assets/js/23.edc4c9cb.js"><link rel="prefetch" href="/front-end-interview/assets/js/24.e12c73cc.js"><link rel="prefetch" href="/front-end-interview/assets/js/26.8d1eeabb.js"><link rel="prefetch" href="/front-end-interview/assets/js/27.87b5c1dd.js">
    <link rel="stylesheet" href="/front-end-interview/assets/css/28.styles.5282d56d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/front-end-interview/" class="home-link router-link-active"><!----><span class="site-name">
      Front End Interview
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end-interview/" class="nav-link">主页</a></div><div class="nav-item"><a href="/front-end-interview/SUMMARY.html" class="nav-link">目录</a></div><a href="https://github.com/lbwa/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end-interview/" class="nav-link">主页</a></div><div class="nav-item"><a href="/front-end-interview/SUMMARY.html" class="nav-link">目录</a></div><a href="https://github.com/lbwa/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>进阶</span><!----></p><ul class="sidebar-group-items"><li><a href="/front-end-interview/advance/adv-virtual-dom.html" class="sidebar-link">virtual DOM</a></li><li><a href="/front-end-interview/advance/adv-mvvm/adv-mvvm.html" class="active sidebar-link">MVVM 架构模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-interview/advance/adv-mvvm/adv-mvvm.html#对-mvvm-的理解" class="sidebar-link">对 MVVM 的理解</a></li><li class="sidebar-sub-header"><a href="/front-end-interview/advance/adv-mvvm/adv-mvvm.html#实现-mvvm" class="sidebar-link">实现 MVVM</a></li></ul></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="mvvm-架构模式"><a href="#mvvm-架构模式" aria-hidden="true" class="header-anchor">#</a> MVVM 架构模式</h1><h2 id="对-mvvm-的理解"><a href="#对-mvvm-的理解" aria-hidden="true" class="header-anchor">#</a> 对 MVVM 的理解</h2><ol><li><p>定义</p><ul><li><p><code>Model</code> 数据模型，一般是 <code>JavaScript</code> 对象，用于存储业务数据。</p></li><li><p><code>ViewModel</code> 视图模型，如 <code>Vue.js</code> 。其中包含视图展示逻辑、数据状态等一系列必要因素。</p></li><li><p><code>View</code> 视图层，即 <code>DOM</code> 树。</p><p><img src="/front-end-interview/assets/img/mvvm.4d341735.png" alt="mvvm-intro"></p></li></ul><p>注：如在 <code>Vue.js</code> 中，通过 <code>DOM listener</code> 监听 <code>View</code> 变化来通知 <code>ViewModel</code> 更新 <code>Model</code>，<code>Model</code> 通过 <code>数据绑定</code>（<code>Data binding</code>）来通知 <code>ViewModel</code> 操作 <code>DOM</code>。</p></li><li><p><code>MVVM</code> 框架（<code>Model-View-ViewModel</code>（<a href="https://zh.wikipedia.org/wiki/MVVM" target="_blank" rel="noopener noreferrer">wiki<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>））三要素</p><ul><li><p>响应式（👉Repo: <a href="https://github.com/lbwa/vue-reactive" target="_blank" rel="noopener noreferrer">演示<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p><ul><li>响应式原理是为了在 <code>web</code> 应用被渲染的数据发生改变时，自行以最优解对目标节点进行更新。或者视图发生变化时，通知 <code>Model</code> 进行数据修改。</li></ul></li><li><p>模板引擎</p><ul><li><p>模板的语法与普通 <code>HTML</code> 语法相近。</p></li><li><p>相较于 <code>HTML</code> 的静态特性，模板是动态的，模板能够实现逻辑（如 <code>v-for</code>、<code>v-if</code>）并且能够内嵌 JS 变量。</p></li></ul><blockquote><p>编译逻辑：模板（字符串） =&gt; 转换为 js 代码实现逻辑和变量 =&gt; HTML</p></blockquote></li><li><p>渲染（<code>ViewModel</code> 中的视图展示逻辑）</p><ul><li><p><code>ViewModel</code> 中的视图展示逻辑通过 <code>render</code> 函数来实现，其中 <code>render</code> 函数的<strong>核心</strong>是 <code>vdom</code>。</p></li><li><p><code>vdom</code> 借由 <code>diff</code> 算法可以在操作 <code>DOM</code> 时带来极低的性能消耗（原因：章节 - <a href="/front-end-interview/advance/adv-virtual-dom.html">Virtual DOM</a>）。</p></li></ul></li></ul></li><li><p>传统 JS 库（如 <code>jQuery</code>）与 <code>MVVM</code> 框架的差异</p><p>最大的区别就是 <code>MVVM</code> 框架实现了 <strong>关注点分离</strong>。</p><ul><li><p>使用传统 JS 框架或原生 JS 开发时：</p><ul><li><p>必须同时顾及业务逻辑实现与 <code>DOM</code> 操作最优解。即数据模型与视图层混杂在一起，<strong>形成耦合</strong>。即<strong>关注点混杂</strong>，后期应用拓展常常需要兼顾之前的模块逻辑，违背开放封闭原则。</p></li><li><p>当 <code>web</code> 应用后期拓展到一定复杂度后，其中的复杂的 <code>DOM</code> 操作将可能带来巨大的性能消耗。后期的拓展和维护也将要付出昂贵的成本，每一次拓展和维护都要顾及对之前的 <code>DOM</code> 树的影响。</p></li><li><p>因为前期不需要搭建额外的视图模型（<code>ViewModel</code>，视图层与数据模型之间通信的桥梁），那么在小型简单 <code>web</code> 应用开发方面传统 JS 框架或原生 JS 开发仍保持着开发流程简洁的优势。</p></li></ul></li><li><p><code>MVVM</code> 框架通过建立一个 <code>视图模型 ViewModel</code> 来解耦 <code>数据模型 Model</code> 和 <code>视图层 View</code>：</p><ul><li><p><strong>建立视图模型（<code>ViewModel</code>）中间层</strong>用于数据模型与视图层的通信，使得后期拓展更易遵循开放封闭原则。</p></li><li><p><strong>以数据驱动视图更新</strong>，只关心数据模型的变化，DOM 操作被封装。开发人员只需要专注 JS 逻辑的实现即可。并不需要直接接触真实 <code>DOM</code>，<code>MVVM</code> 框架会自行通过 <code>web</code> 应用的数据来驱动真实 <code>DOM</code> 的渲染。所有真实 <code>DOM</code> 树的更新都是依靠 <code>ViewModel</code> 来实施高效的页面渲染和更新。</p></li></ul></li></ul></li></ol><h2 id="实现-mvvm"><a href="#实现-mvvm" aria-hidden="true" class="header-anchor">#</a> 实现 MVVM</h2><p>（以 <code>Vue.js</code> 为例）</p><h3 id="_1-vue-js-中响应式原理"><a href="#_1-vue-js-中响应式原理" aria-hidden="true" class="header-anchor">#</a> 1. Vue.js 中响应式原理</h3><p>（👉Repo: <a href="https://github.com/lbwa/vue-reactive" target="_blank" rel="noopener noreferrer">演示<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p><h3 id="_2-vue-js-如何解析模板"><a href="#_2-vue-js-如何解析模板" aria-hidden="true" class="header-anchor">#</a> 2. Vue.js 如何解析模板</h3><ol><li><p>模板</p><ol><li><p>本质：字符串</p></li><li><p>内含<strong>逻辑</strong>语句，如 <code>v-if</code>、<code>v-for</code> 等语句</p></li><li><p>对比静态的 <code>HTML</code>，模板是<strong>动态</strong>的。</p></li><li><p>最终的编译结果是 <code>HTML</code>。</p><ul><li><p>模板必须转换为 JS 代码来实现模板中的<strong>逻辑</strong>语句和引用的 JS <strong>变量</strong>。</p><ul><li>前端三大语言中只有 JS 具有逻辑实现，即图灵完备语言。</li></ul></li><li><p>三大语言中只有 JS （<code>render</code> 函数）能实现将字符串转换为 <code>HTML</code>。</p></li></ul></li></ol></li><li><p><code>render</code> 函数</p><ol><li><p>模板中的所有信息在 <code>render</code> 函数中均有体现</p><ul><li>模板如下：</li></ul><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>{{name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><code>render</code> 函数体如下：</li></ul><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// with 用于指定 with 代码块中的上一级作用域，在查询当前作用域中未声明变量的声明时，起作用</span>
<span class="token comment">// this 指向 vue 实例 vm</span>
<span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// _c 即 vm._c，调用 createElement()，即创建 vnode</span>
  <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span>
    <span class="token string">'div'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      attrs<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'id'</span><span class="token punctuation">:</span> <span class="token string">'app'</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">[</span>
      <span class="token comment">// name 即 vm.name 即 vm._data.name</span>
      <span class="token comment">// vm._v 即 createTextVNode(val)，创建 文本 vnode</span>
      <span class="token comment">// vm._s 即 toString(val)，转换变量 name 为字符串</span>
      <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>注：暂只关心设计理念，模板转换为 JS 代码（<code>render</code> 函数）的过程属于工具化细节，暂不过多纠结。</p></li><li><p><code>Vue.js</code> 指令实现</p><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>msg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@keyup.enter</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>inputPanel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 拦截 Vue.js 源码中 `code.render` 可以得到当前模板转换后的 render 函数</span>
<span class="token keyword">with</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// this 即为 vm</span>
  <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span>
    <span class="token string">'input'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      directives<span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          name<span class="token punctuation">:</span> <span class="token string">&quot;model&quot;</span><span class="token punctuation">,</span>
          rawName<span class="token punctuation">:</span> <span class="token string">&quot;v-model&quot;</span><span class="token punctuation">,</span>
          <span class="token comment">// v-model 绑定的值</span>
          value<span class="token punctuation">:</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
          expression<span class="token punctuation">:</span> <span class="token string">&quot;msg&quot;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span> 
      <span class="token comment">// HTML 标签字符串的属性</span>
      attrs<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;text&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;inputPanel&quot;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// DOM 树对象（由浏览器转换 HTML 字符串而来）自身的属性</span>
      domProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// DOM 绑定 vm.msg</span>
        <span class="token comment">// 即当赋值 vm.msg 时，DOM 会做出相应改变</span>
        <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// 监听事件</span>
      on<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;keyup&quot;</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>$event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token string">'button'</span> <span class="token keyword">in</span> $event<span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> <span class="token function">_k</span><span class="token punctuation">(</span>$event<span class="token punctuation">.</span>keyCode<span class="token punctuation">,</span> <span class="token string">&quot;enter&quot;</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> $event<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token string">&quot;Enter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">submit</span><span class="token punctuation">(</span>$event<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token comment">// 由 v-model 指令添加的 input 事件监听</span>
        <span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>$event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>$event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          <span class="token comment">// 当输入事件触发时，设置 vm.msg 的值</span>
          msg <span class="token operator">=</span> $event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><ul><li><p>v-model 实现</p><p><code>v-model</code> 指令本质是一个语法糖，他是监听 <code>DOM</code> 树对象属性和监听 <code>input</code> 事件的封装。</p><div class="language-js line-numbers-mode"><pre class="language-js"><code>domProps<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 即 document.querySelector('input').value = msg</span>
  <span class="token string">&quot;value&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
on<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 此处亦是 v-on 的实现</span>
  <span class="token string">&quot;input&quot;</span><span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>$event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>$event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>composing<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// 当输入事件触发时，设置 vm.msg 的值</span>
    msg <span class="token operator">=</span> $event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li><li><p><code>v-for</code> 实现</p><p><code>v-for</code> 本质是 <code>for 循环</code> 得到目标元素的 <code>render</code> 函数所构成的数组，该数组可用于父 <code>render</code> 函数中。</p><p>（<code>v-if</code> 本质是 <code>if 语句判断</code>）</p><p>模板如下：</p><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>item in items<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{item}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>render</code> 函数如下：</p><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">_c</span><span class="token punctuation">(</span>
  <span class="token string">'ul'</span><span class="token punctuation">,</span>
  <span class="token comment">// vm._l 即 renderList 函数</span>
  <span class="token comment">// 返回一个每项均为 li 的 render 函数的数组</span>
  <span class="token function">_l</span><span class="token punctuation">(</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span>
        <span class="token string">'li'</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span>
          <span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></li></ul></li><li><p><code>render</code> 函数（<code>vm._c</code>）逻辑</p><p><code>Vue.js</code> 中的 <code>render</code> 函数是由 <code>snabbdom</code> 演变而来。如他们的传参方式。</p><ul><li><p><code>vm._c</code> 即相当于 <code>snabbdom</code> 中的 <code>h</code> 函数（API 见章节 - <a href="/front-end-interview/advance/adv-virtual-dom.html">Virtual DOM</a>），最终将创建一个 <code>vnode</code>。</p><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 1. src/core/instance/lifecycle.js 定义 Vue.prototype._update = function () {}
 * 2. vm._update 用于对比新旧 vnode 的差异
 */</span>
vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在对比新旧 vnode 之前，缓存旧的 vnode</span>
  <span class="token keyword">const</span> prevVnode <span class="token operator">=</span> vm<span class="token punctuation">.</span>_vnode

  <span class="token comment">// 缓存新的 vnode，用于下一次对比</span>
  vm<span class="token punctuation">.</span>_vnode <span class="token operator">=</span> vnode
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>prevVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 初次渲染，挂载到 vm.$el 上，并渲染出真实 DOM，并形成 DOM 映射</span>
    <span class="token comment">// vm.__patch__ 即如同 snabbdom 中的 patch 函数</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>$el<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

    <span class="token comment">// 将新 vnode 对比旧的 vnode 得到差异并根据 DOM 映射进行 DOM 更新</span>
    vm<span class="token punctuation">.</span>$el <span class="token operator">=</span> vm<span class="token punctuation">.</span><span class="token function">__patch__</span><span class="token punctuation">(</span>prevVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 1. src/core/instance/lifecycle.js 定义
 * 2. 仅用于 Watcher 实例中
 * 结合响应式原理：
 * vm.$data[someData] 的 setter
 * --&gt; dep.notify()
 * --&gt; subs[i].update()
 * --&gt; updateComponent
 * --&gt; vm._render
 */</span>
<span class="token keyword">function</span> <span class="token function">updateComponent</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// vm._render() 即 render 函数，即 vm._c，调用后将返回一个新的 vnode</span>
  vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div></li></ul></li></ol></li></ol><h3 id="_3-vue-js-实现的整体流程"><a href="#_3-vue-js-实现的整体流程" aria-hidden="true" class="header-anchor">#</a> 3. Vue.js 实现的整体流程</h3><ol><li><p>解析模板为 JS 代码实现模板中的逻辑，并构建 <code>render</code> 函数</p><ul><li><p>实现 <code>v-if</code>、<code>v-for</code>、<code>v-on</code> 等模板中的逻辑语句。</p></li><li><p>构建 <code>render</code> 函数，并得到 <code>vdom</code>，<code>vdom</code> 与将真实 <code>DOM</code> 树形成映射。</p></li></ul></li><li><p>形成响应式机制</p><ul><li><p>重写 <code>数据对象</code>（如 <code>vm.$data[dataName]</code>） 的 <code>getter</code> 和 <code>setter</code>。</p><ul><li><p><code>getter</code> 添加 <code>收集依赖</code> 方法 <code>dep.depend()</code>，使其<strong>选择性</strong>在依赖收集容器 <code>dep.subs</code> 中添加数据依赖 <code>Watcher</code>，以避免不必要的渲染。</p><ul><li><p>之所以建立 <code>dep.depend()</code>，是为了只为 <strong>参与构建</strong><code>DOM</code> 的数据对象 <code>$data[someData]</code> 提供数据依赖。</p><ul><li>实现逻辑：添加当前 <code>Watcher</code> 实例（即数据依赖）到当前数据依赖存储容器 <code>dep.subs</code> 中（<a href="https://github.com/lbwa/vue-reactive#watcher" target="_blank" rel="noopener noreferrer">详细<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</li></ul></li><li><p>每个 <code>数据对象</code> 都有一个独享的 <code>dep</code> 实例，它是以<strong>闭包变量</strong>的形式与<strong>每个</strong><code>数据对象</code> 相关联（<a href="https://github.com/lbwa/vue-reactive/blob/master/reactive.js#L8" target="_blank" rel="noopener noreferrer">示例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p></li></ul></li><li><p><code>setter</code> 添加 <code>更新依赖</code> 函数 <code>dep.notify()</code>，使其在变化时触发依赖收集更新。</p><ul><li>在 <code>setter</code> 中触发更新依赖函数时，未参与构建 <code>DOM</code> 中的数据对象容器是没有数据依赖的（即 <code>dep.subs</code> 为空数组），即不会触发后续的一系列更新 <code>DOM</code> 的方法，即<strong>避免了不必要的重复渲染</strong>。</li></ul></li></ul><p>注：<code>Vue.js</code> 中数据依赖都是以 <code>Watcher</code> 的实例为形式存储的（<code>subs</code> 数组），<code>Watcher</code> 存在一个原型方法 <code>update</code>。<code>update</code> 方法在被调用时，将调用 <code>Vue</code> 的原型方法 <code>_render</code>（即 <code>render</code> 函数）。</p></li><li><p>在 <code>Vue.js</code> 中将 <code>data</code> 选项中的属性代理到 <code>Vue</code> 实例下。</p><ul><li>因为在 <code>render</code> 函数中指定了 <code>with</code> 作用域都是在 <code>Vue</code> 实例下，而不是 <code>data</code> 之类的选项中，那么此处的数据代理是必不可少的。</li></ul></li><li><p><code>DOM listener</code> 监听 <code>View</code> 层的 <code>DOM</code> 树对象属性的变化。</p></li></ul></li></ol><ol start="3"><li><p>首次渲染，且绑定依赖</p><ul><li><p>将 <code>render</code> 函数渲染成真实 <code>DOM</code>。</p><ul><li>执行 <code>render</code> 函数实现初次 <code>DOM</code> 渲染。</li></ul><blockquote><p><code>updateComponent</code> --&gt; <code>vm._render</code> --&gt; <code>vm.__patch__(vm.$el, vnode)</code> --&gt; 生成 <code>DOM</code> 树</p></blockquote><ul><li>缓存当次的 <code>vnode</code> 为 <code>vm._vnode</code> 以用于下次 <code>vm.__patch__(vnode, prevVnode)</code> 成为 <code>prevVnode</code> 对比新的 <code>vnode</code>。</li></ul></li><li><p>绑定依赖</p><ul><li>在执行 <code>render</code> 函数时，就会访问到 <code>数据对象</code>（因为先前在模板中使用了代表 <code>数据对象</code> 的变量，需要将变量转化为 <code>DOM</code> 节点），就会触发 <code>2</code> 中的响应式机制，即触发 <code>getter</code> 函数中的 <code>dep.depend()</code>，那么就会只对 <strong>参与构建</strong><code>DOM</code> 树的 <code>数据对象</code> 开始收集数据依赖并存储于容器中。</li></ul></li></ul></li><li><p>响应式机制的依赖发生变化时将触发 <code>re-render</code></p><ul><li><code>Model</code> 层发生变化</li></ul><blockquote><p><code>vm.$data[dataName]</code> 的 <code>setter</code> --&gt; <code>dep.notify()</code> --&gt; <code>subs[i].update()</code> --&gt; <code>updateComponent</code> --&gt; <code>vm._render</code> --&gt; <code>vdom</code> 中的 <code>vm.__patch__(vnode, prevVnode)</code> --&gt; 更新 <code>DOM</code></p></blockquote><ul><li><p>补充：<code>View</code> 层发生变化</p><p><code>View</code> 层将通知 <code>ViewModel</code> 以更新对应 <code>Model</code> 中的值。</p><p><img src="/front-end-interview/assets/img/mvvm-vue.78995808.png" alt="mvvm-mind-map"></p></li></ul></li></ol></div><div class="content edit-link"><!----><!----></div><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/front-end-interview/advance/adv-virtual-dom.html" class="prev">
          virtual DOM
        </a></span><!----></p></div></div></div></div>
    <script src="/front-end-interview/assets/js/25.bc1c1bd1.js" defer></script><script src="/front-end-interview/assets/js/app.5649801c.js" defer></script>
  </body>
</html>
