<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Front End Interview | virtual DOM</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/front-end-interview/assets/css/28.styles.5282d56d.css" as="style"><link rel="preload" href="/front-end-interview/assets/js/app.45c40364.js" as="script"><link rel="preload" href="/front-end-interview/assets/js/24.e12c73cc.js" as="script"><link rel="prefetch" href="/front-end-interview/assets/js/12.b0b8bdc2.js"><link rel="prefetch" href="/front-end-interview/assets/js/0.63cbeaf2.js"><link rel="prefetch" href="/front-end-interview/assets/js/1.2d9d638f.js"><link rel="prefetch" href="/front-end-interview/assets/js/2.4ca1fdf9.js"><link rel="prefetch" href="/front-end-interview/assets/js/3.2e3fe001.js"><link rel="prefetch" href="/front-end-interview/assets/js/4.31fbc22a.js"><link rel="prefetch" href="/front-end-interview/assets/js/5.5ef9f123.js"><link rel="prefetch" href="/front-end-interview/assets/js/6.dfe2fc39.js"><link rel="prefetch" href="/front-end-interview/assets/js/7.3bea5043.js"><link rel="prefetch" href="/front-end-interview/assets/js/8.85ebb90b.js"><link rel="prefetch" href="/front-end-interview/assets/js/9.4189ba80.js"><link rel="prefetch" href="/front-end-interview/assets/js/10.56769ad8.js"><link rel="prefetch" href="/front-end-interview/assets/js/11.ee626e29.js"><link rel="prefetch" href="/front-end-interview/assets/js/13.a613c252.js"><link rel="prefetch" href="/front-end-interview/assets/js/14.06b06448.js"><link rel="prefetch" href="/front-end-interview/assets/js/15.7abf1950.js"><link rel="prefetch" href="/front-end-interview/assets/js/16.3b6bf73b.js"><link rel="prefetch" href="/front-end-interview/assets/js/17.66f95366.js"><link rel="prefetch" href="/front-end-interview/assets/js/18.3924f170.js"><link rel="prefetch" href="/front-end-interview/assets/js/19.bf168d25.js"><link rel="prefetch" href="/front-end-interview/assets/js/20.0d3a49f3.js"><link rel="prefetch" href="/front-end-interview/assets/js/21.f5a65c71.js"><link rel="prefetch" href="/front-end-interview/assets/js/22.cfd6dc92.js"><link rel="prefetch" href="/front-end-interview/assets/js/23.edc4c9cb.js"><link rel="prefetch" href="/front-end-interview/assets/js/25.bc1c1bd1.js"><link rel="prefetch" href="/front-end-interview/assets/js/26.8d1eeabb.js"><link rel="prefetch" href="/front-end-interview/assets/js/27.87b5c1dd.js">
    <link rel="stylesheet" href="/front-end-interview/assets/css/28.styles.5282d56d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/front-end-interview/" class="home-link router-link-active"><!----><span class="site-name">
      Front End Interview
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/front-end-interview/" class="nav-link">主页</a></div><div class="nav-item"><a href="/front-end-interview/SUMMARY.html" class="nav-link">目录</a></div><a href="https://github.com/lbwa/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/front-end-interview/" class="nav-link">主页</a></div><div class="nav-item"><a href="/front-end-interview/SUMMARY.html" class="nav-link">目录</a></div><a href="https://github.com/lbwa/front-end-interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>进阶</span><!----></p><ul class="sidebar-group-items"><li><a href="/front-end-interview/advance/adv-virtual-dom.html" class="active sidebar-link">virtual DOM</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end-interview/advance/adv-virtual-dom.html#vdom-定义" class="sidebar-link">vdom 定义</a></li><li class="sidebar-sub-header"><a href="/front-end-interview/advance/adv-virtual-dom.html#vdom-api" class="sidebar-link">vdom API</a></li><li class="sidebar-sub-header"><a href="/front-end-interview/advance/adv-virtual-dom.html#diff-算法-——-vdom-核心" class="sidebar-link">diff 算法 —— vdom 核心</a></li></ul></li><li><a href="/front-end-interview/advance/adv-mvvm/adv-mvvm.html" class="sidebar-link">MVVM 架构模式</a></li></ul></div></li></ul></div><div class="page"><div class="content"><h1 id="virtual-dom"><a href="#virtual-dom" aria-hidden="true" class="header-anchor">#</a> virtual DOM</h1><p>一般将 <code>virtual DOM</code> 简写为 <code>vdom</code>。<code>vdom</code> 的目的是以最优解去更新 <code>DOM</code>，那么就要保证更新节点的查询次数最少（<code>vnode</code>更新节点不需要查询），更新的影响范围最小（依靠 <code>vnode.elm</code> 精确定位节点）。</p><h2 id="vdom-定义"><a href="#vdom-定义" aria-hidden="true" class="header-anchor">#</a> vdom 定义</h2><ol><li><p>含义：用 JS 对象来映射模拟 <code>DOM</code> 结构</p><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'test'</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token comment">// 生成 vnode</span>
<span class="token punctuation">{</span>
  children<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span> <span class="token comment">// 数组，表示当前节点的 Element 类型子节点的子 vnode</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// 当前节点的属性</span>
    id<span class="token punctuation">:</span> <span class="token string">'data'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  elm<span class="token punctuation">:</span> div<span class="token punctuation">,</span> <span class="token comment">// 映射真实 DOM 树节点，即此处是 vdom 精确更新修改后节点的关键之一</span>
  key<span class="token punctuation">:</span> undefined<span class="token punctuation">,</span>
  sel<span class="token punctuation">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token comment">// h() 第一参数，用于创建真实节点</span>
  text<span class="token punctuation">:</span> <span class="token string">'hello'</span> <span class="token comment">// 当前节点的文本节点，与 children 属性互斥</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li><li><p>原理：在 JS 层通过 <code>diff</code> 算法来对比 <code>DOM</code> 的结构变化</p><ul><li><p>浏览器中最<strong>耗时</strong>的操作即是 <code>DOM</code> 操作，直接操作 <code>DOM</code>，将带来巨大的性能开销，所以在没有使用 <code>vdom</code> 时，需要我们尽可能减少 <code>DOM</code> 操作。</p></li><li><p>JS 的执行速度<strong>远远快于</strong>浏览器 <code>DOM</code> 渲染速度。所以在 JS 层来处理 <code>DOM</code> 结构变化将大大降低性能开销。结果将是以<strong>最优解</strong>（最小的改动范围，最少的改动次数）去改变 <code>DOM</code> 结构。</p><ul><li><p>借助 <code>diff</code> 算法对比新旧 <code>vnode</code> 的差异。</p></li><li><p><code>vnode.elm</code> 与真实 <code>DOM</code> 树节点形成映射，进行<strong>精准更新</strong>，避免了 <code>DOM</code> 节点查询。</p></li></ul></li><li><p>前端中只有 JS 是图灵完备语言 —— 能执行算法的语言</p></li></ul></li><li><p>目的：提高重绘性能。即是 <code>vdom</code> 存在的意义。</p></li></ol><h2 id="vdom-api"><a href="#vdom-api" aria-hidden="true" class="header-anchor">#</a> vdom API</h2><ul><li><p>核心：</p><ul><li><p><code>h</code> 函数：生成 <code>vnode</code>。</p></li><li><p><code>patch</code> 函数：对比新旧 <code>vnode</code>，并生成或更新 <code>DOM</code> 节点。</p></li></ul></li></ul><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// const snabbdom = require('sanbbdom')</span>
<span class="token keyword">import</span> snabbdom <span class="token keyword">from</span> <span class="token string">'snabbdom'</span>
<span class="token keyword">import</span> h <span class="token keyword">from</span> <span class="token string">'snabbdom/h'</span>
<span class="token keyword">import</span> snabbdom_class <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/class'</span>
<span class="token keyword">import</span> snabbdom_props <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/props'</span>
<span class="token keyword">import</span> snabbdom_style <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/style'</span>
<span class="token keyword">import</span> snabbdom_eventlistener <span class="token keyword">from</span> <span class="token string">'snabbdom/modules/eventlistener'</span>

<span class="token comment">// 初始化 patch</span>
<span class="token keyword">const</span> patch <span class="token operator">=</span> snabbdom<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  snabbdom_class<span class="token punctuation">,</span>
  snabbdom_props<span class="token punctuation">,</span>
  snabbdom_style<span class="token punctuation">,</span>
  snabbdom_eventlisteners
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 生成 vnode</span>
<span class="token function">h</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token comment">/* 标签名 */</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token comment">/* 属性 */</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token comment">/* 子元素 */</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">h</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token comment">/* 标签名 */</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token comment">/* 属性 */</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token comment">/* 文本节点 */</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>

<span class="token comment">// 生成并修改 DOM</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#container'</span><span class="token punctuation">)</span>

<span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span> <span class="token comment">// vnode 初次渲染至 container 容器中</span>
<span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span> <span class="token comment">// 利用 js 对比新旧 vnode 来得到操作 DOM 的最优解</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>以下示例如何生成一个 <code>table</code> 表格：</p><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'name'</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token string">'age'</span><span class="token punctuation">,</span>
    address<span class="token punctuation">:</span> <span class="token string">'address'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'John Wick'</span><span class="token punctuation">,</span>
    age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
    address<span class="token punctuation">:</span> <span class="token string">'Shanghai'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token keyword">let</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 缓存容器</span>

<span class="token keyword">function</span> <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 生成 vnode</span>
  <span class="token keyword">const</span> newVnode <span class="token operator">=</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> tds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      tds<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'td'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 返回一个以 tr 元素的 vnode 组成的数组</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'tr'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> tds<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 缓存 vnode</span>
  vnode <span class="token operator">=</span> newVnode
<span class="token punctuation">}</span>

<span class="token function">render</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>得到表格如下：</p><table><thead><tr><th>name</th><th>age</th><th>address</th></tr></thead><tbody><tr><td>John Wick</td><td>20</td><td>Shanghai</td></tr></tbody></table><p><code>DOM</code> 树如下：</p><div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>age<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>address<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>John Wick<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">&gt;</span></span>Shanghai<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="diff-算法-——-vdom-核心"><a href="#diff-算法-——-vdom-核心" aria-hidden="true" class="header-anchor">#</a> diff 算法 —— vdom 核心</h2><ol><li><p>定义</p><ul><li><p><code>linux</code> 中的 <code>diff</code> 命令。</p><div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">diff</span> a.js a1.js
<span class="token comment"># 将打印 a.js 与 a1.js 的差异</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p><code>diff</code> 算法并非 <code>vdom</code> 的原创算法。</p></li></ul></li><li><p><code>vdom</code> 使用 <code>diff</code> 算法的原因</p><ul><li>依靠 <code>diff</code> 算法，可以<strong>找到</strong>新旧 <code>vnode</code> 中的差异点，即是必须更新的节点（依据 <code>vnode.elm</code> 得到映射的真实 <code>DOM</code> 树节点进更新），而其他节点则保持不变。</li></ul></li><li><p><code>diff</code> 算法核心实现流程</p><ul><li><p>初次渲染，将 <code>vnode</code> 初次转换成 <code>DOM</code> 节点</p><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">patch</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 仅用于体现转换逻辑，并非真实体现</span>
<span class="token keyword">function</span> <span class="token function">createElement</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tag <span class="token operator">=</span> vnode<span class="token punctuation">.</span>sel
  <span class="token keyword">const</span> attrs <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tag<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span>

  <span class="token comment">// 创建元素</span>
  <span class="token keyword">const</span> ele <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span>

  <span class="token comment">// 设置节点属性</span>
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    ele<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> attrs<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 插入子元素</span>
  children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>childVnode <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 递归创建子节点的后代节点（若有的话）</span>
    ele<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token function">createElement</span><span class="token punctuation">(</span>childVnode<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 返回真正 DOM 节点</span>
  <span class="token keyword">return</span> ele
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>以上逻辑主要展现 <code>vnode</code> 的初次渲染。于 <code>patch</code> 方法中， <code>container</code> 为渲染容器。</p></li><li><p>渲染更新</p><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">patch</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">updateChildren</span> <span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> children <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">const</span> newChildren <span class="token operator">=</span> newVnode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>childVnode<span class="token punctuation">,</span> index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newChildVnode <span class="token operator">=</span> newChildren<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>childVnode<span class="token punctuation">.</span>sel <span class="token operator">===</span> newChildVnode<span class="token punctuation">.</span>sel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 递归子节点的后代节点进行对比</span>
      <span class="token function">updateChildren</span><span class="token punctuation">(</span>childVnode newChildVnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token function">replaceNode</span><span class="token punctuation">(</span>childVnode<span class="token punctuation">,</span> newChildVnode<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">replaceNode</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> newVnode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm
  <span class="token keyword">const</span> newElm <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span>newVnode<span class="token punctuation">)</span>

  <span class="token comment">// DOM 替换 ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>以上逻辑主要展现 <code>vnode</code> 更新。在得到 <code>newVnode</code> 后传入 <code>patch</code> 函数，<code>patch</code> 函数将根据 <code>diff</code> 算法得到 <code>vnode</code> 与 <code>newVnode</code> 之间的差异，之后执行精确的 <code>DOM</code> 更新。</p></li></ul></li></ol></div><div class="content edit-link"><!----><div class="last-updated"><span class="prefix">Last Updated: </span><span class="time">6/2/2018, 1:24:28 AM</span></div></div><div class="content page-nav"><p class="inner"><!----><span class="next"><a href="/front-end-interview/advance/adv-mvvm/adv-mvvm.html">
          MVVM 架构模式
        </a> →
      </span></p></div></div></div></div>
    <script src="/front-end-interview/assets/js/24.e12c73cc.js" defer></script><script src="/front-end-interview/assets/js/app.45c40364.js" defer></script>
  </body>
</html>
